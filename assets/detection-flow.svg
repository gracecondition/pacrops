<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="1000" height="1800" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <!-- Define styles -->
  <defs>
    <style type="text/css">
      .stage-box { fill: #2c3e50; stroke: #34495e; stroke-width: 2; }
      .decision-box { fill: #e74c3c; stroke: #c0392b; stroke-width: 2; }
      .safe-box { fill: #27ae60; stroke: #229954; stroke-width: 2; }
      .critical-box { fill: #e74c3c; stroke: #c0392b; stroke-width: 2; }
      .high-box { fill: #e67e22; stroke: #d35400; stroke-width: 2; }
      .medium-box { fill: #f39c12; stroke: #e67e22; stroke-width: 2; }
      .header-text { fill: white; font-family: 'Arial', sans-serif; font-size: 18px; font-weight: bold; text-anchor: middle; }
      .body-text { fill: white; font-family: 'Arial', sans-serif; font-size: 14px; text-anchor: start; }
      .small-text { fill: white; font-family: 'Arial', sans-serif; font-size: 12px; text-anchor: start; }
      .decision-text { fill: white; font-family: 'Arial', sans-serif; font-size: 13px; font-weight: bold; text-anchor: middle; }
      .arrow { fill: none; stroke: #3498db; stroke-width: 3; marker-end: url(#arrowhead); }
      .arrow-no { fill: none; stroke: #95a5a6; stroke-width: 2; marker-end: url(#arrowhead-gray); }
      .label-text { fill: #7f8c8d; font-family: 'Arial', sans-serif; font-size: 12px; font-style: italic; }
    </style>

    <!-- Arrow markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3498db" />
    </marker>
    <marker id="arrowhead-gray" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#95a5a6" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="500" y="30" style="fill: #2c3e50; font-family: Arial; font-size: 24px; font-weight: bold; text-anchor: middle;">
    PAC-aware ROP Gadget Detection Engine
  </text>

  <!-- Stage 1: Binary Input -->
  <rect x="300" y="60" width="400" height="60" class="stage-box" rx="5"/>
  <text x="500" y="85" class="header-text">ARM64 Binary Input</text>
  <text x="320" y="105" class="small-text">• Executable sections loaded from ELF/Mach-O</text>

  <!-- Arrow -->
  <path d="M 500 120 L 500 150" class="arrow"/>

  <!-- Stage 2: Disassembly -->
  <rect x="250" y="150" width="500" height="80" class="stage-box" rx="5"/>
  <text x="500" y="175" class="header-text">Stage 1: Disassembly (Capstone)</text>
  <text x="270" y="195" class="small-text">• Parse binary executable sections</text>
  <text x="270" y="210" class="small-text">• Disassemble all ARM64 instructions</text>
  <text x="270" y="225" class="small-text">• Extract mnemonic, operands, addresses</text>

  <!-- Arrow -->
  <path d="M 500 230 L 500 260" class="arrow"/>

  <!-- Stage 3: Control Flow Detection -->
  <rect x="250" y="260" width="500" height="95" class="stage-box" rx="5"/>
  <text x="500" y="285" class="header-text">Stage 2: Find Control-Flow Instructions</text>
  <text x="270" y="305" class="small-text">• Scan for: ret, retaa, retab, br, blr</text>
  <text x="270" y="320" class="small-text">• Each marks a potential gadget endpoint</text>
  <text x="270" y="335" class="small-text">• Source: src/gadget.rs:4-6</text>
  <text x="270" y="350" class="small-text">  is_control_flow_instruction()</text>

  <!-- Arrow -->
  <path d="M 500 355 L 500 385" class="arrow"/>

  <!-- Stage 4: Gadget Extraction -->
  <rect x="250" y="385" width="500" height="110" class="stage-box" rx="5"/>
  <text x="500" y="410" class="header-text">Stage 3: Extract Gadgets</text>
  <text x="270" y="430" class="small-text">• For each control-flow instruction at position i:</text>
  <text x="270" y="445" class="small-text">  - Look backwards up to max_gadget_size (default: 10)</text>
  <text x="270" y="460" class="small-text">  - Create gadgets: [insn[i]], [insn[i-1], insn[i]], ...</text>
  <text x="270" y="475" class="small-text">  - Up to 10-instruction sequences per endpoint</text>
  <text x="270" y="490" class="small-text">• Source: src/gadget.rs:8-30</text>

  <!-- Arrow -->
  <path d="M 500 495 L 500 525" class="arrow"/>

  <!-- Stage 5: PAC Instruction Identification -->
  <rect x="250" y="525" width="500" height="110" class="stage-box" rx="5"/>
  <text x="500" y="550" class="header-text">Stage 4: Identify PAC Instructions</text>
  <text x="270" y="570" class="small-text">• Scan each gadget for PAC mnemonics:</text>
  <text x="270" y="585" class="small-text">  - Sign: paciasp, paciaz, pacia, pacibsp, pacibz, pacib</text>
  <text x="270" y="600" class="small-text">  - Auth: autiasp, autiaz, autia, autibsp, autibz, autib</text>
  <text x="270" y="615" class="small-text">  - Combined: retaa, retab</text>
  <text x="270" y="630" class="small-text">• Track keys (A/B) and modifiers (SP/zero/register)</text>

  <!-- Arrow -->
  <path d="M 500 635 L 500 665" class="arrow"/>

  <!-- Stage 6: Vulnerability Classification Header -->
  <rect x="200" y="665" width="600" height="40" class="decision-box" rx="5"/>
  <text x="500" y="690" class="header-text">Stage 5: Vulnerability Classification (Priority Order)</text>

  <!-- Arrow -->
  <path d="M 500 705 L 500 730" class="arrow"/>

  <!-- Decision 1: UNSIGNED-BR -->
  <rect x="300" y="730" width="400" height="60" class="critical-box" rx="5"/>
  <text x="500" y="750" class="decision-text">1. Contains br/blr?</text>
  <text x="320" y="770" class="small-text">Unsigned indirect branch - no PAC authentication</text>
  <text x="320" y="785" class="small-text">→ UNSIGNED-BR [CRITICAL]</text>

  <!-- Arrow down (No) -->
  <path d="M 500 790 L 500 820" class="arrow-no"/>
  <text x="510" y="810" class="label-text">No</text>

  <!-- Decision 2: STACK-PIVOT -->
  <rect x="300" y="820" width="400" height="60" class="critical-box" rx="5"/>
  <text x="500" y="840" class="decision-text">2. Modifies SP before autiasp/autibsp?</text>
  <text x="320" y="860" class="small-text">Stack pointer changed before authentication</text>
  <text x="320" y="875" class="small-text">→ STACK-PIVOT [CRITICAL]</text>

  <!-- Arrow down (No) -->
  <path d="M 500 880 L 500 910" class="arrow-no"/>
  <text x="510" y="900" class="label-text">No</text>

  <!-- Decision 3: KEY-CONFUSION -->
  <rect x="300" y="910" width="400" height="60" class="critical-box" rx="5"/>
  <text x="500" y="930" class="decision-text">3. Sign with A key, auth with B? (or vice versa)</text>
  <text x="320" y="950" class="small-text">PAC key mismatch between sign and auth</text>
  <text x="320" y="965" class="small-text">→ KEY-CONFUSION [CRITICAL]</text>

  <!-- Arrow down (No) -->
  <path d="M 500 970 L 500 1000" class="arrow-no"/>
  <text x="510" y="990" class="label-text">No</text>

  <!-- Decision 4: MODIFIER-CONFUSION -->
  <rect x="300" y="1000" width="400" height="60" class="high-box" rx="5"/>
  <text x="500" y="1020" class="decision-text">4. Sign with SP, auth with zero? (or vice versa)</text>
  <text x="320" y="1040" class="small-text">PAC modifier mismatch between sign and auth</text>
  <text x="320" y="1055" class="small-text">→ MODIFIER-CONFUSION [HIGH]</text>

  <!-- Arrow down (No) -->
  <path d="M 500 1060 L 500 1090" class="arrow-no"/>
  <text x="510" y="1080" class="label-text">No</text>

  <!-- Decision 5: CONTEXT-MANIPULATION -->
  <rect x="300" y="1090" width="400" height="60" class="medium-box" rx="5"/>
  <text x="500" y="1110" class="decision-text">5. Modifies x30/lr register?</text>
  <text x="320" y="1130" class="small-text">Loads return address from memory before auth</text>
  <text x="320" y="1145" class="small-text">→ CONTEXT-MANIPULATION [MEDIUM]</text>

  <!-- Arrow down (No) -->
  <path d="M 500 1150 L 500 1180" class="arrow-no"/>
  <text x="510" y="1170" class="label-text">No</text>

  <!-- Decision 6: REPLAY-VULNERABLE -->
  <rect x="300" y="1180" width="400" height="60" class="high-box" rx="5"/>
  <text x="500" y="1200" class="decision-text">6. Uses zero modifier (paciaz/pacibz)?</text>
  <text x="320" y="1220" class="small-text">Predictable PAC values - replay attacks possible</text>
  <text x="320" y="1235" class="small-text">→ REPLAY-VULNERABLE [HIGH]</text>

  <!-- Arrow down (No) -->
  <path d="M 500 1240 L 500 1270" class="arrow-no"/>
  <text x="510" y="1260" class="label-text">No</text>

  <!-- Decision 7: Final Classification -->
  <rect x="220" y="1270" width="560" height="80" rx="5" style="fill: #34495e; stroke: #2c3e50; stroke-width: 2;"/>
  <text x="500" y="1295" class="decision-text">7. Final Classification</text>

  <!-- Split into two outcomes -->
  <g>
    <rect x="250" y="1310" width="220" height="35" class="safe-box" rx="3"/>
    <text x="360" y="1332" class="small-text" style="text-anchor: middle;">Has PAC sign/auth?</text>
    <text x="360" y="1345" class="small-text" style="text-anchor: middle; font-weight: bold;">→ PAC-SAFE</text>
  </g>

  <g>
    <rect x="530" y="1310" width="220" height="35" class="critical-box" rx="3"/>
    <text x="640" y="1332" class="small-text" style="text-anchor: middle;">No PAC instructions?</text>
    <text x="640" y="1345" class="small-text" style="text-anchor: middle; font-weight: bold;">→ UNSIGNED [CRITICAL]</text>
  </g>

  <!-- Arrows to output -->
  <path d="M 360 1345 L 360 1380 L 500 1380" class="arrow"/>
  <path d="M 640 1345 L 640 1380 L 500 1380" class="arrow"/>

  <!-- Stage 7: Output -->
  <rect x="250" y="1400" width="500" height="95" class="stage-box" rx="5"/>
  <text x="500" y="1425" class="header-text">Stage 6: Output Generation</text>
  <text x="270" y="1445" class="small-text">• Group gadgets by vulnerability type</text>
  <text x="270" y="1460" class="small-text">• Generate statistics (total, exploitable count)</text>
  <text x="270" y="1475" class="small-text">• Format output (text or JSON)</text>
  <text x="270" y="1490" class="small-text">• Highlight critical vulnerabilities</text>

  <!-- Legend -->
  <g transform="translate(50, 1550)">
    <text x="0" y="0" style="fill: #2c3e50; font-family: Arial; font-size: 16px; font-weight: bold;">Legend:</text>

    <rect x="0" y="10" width="30" height="20" class="critical-box" rx="2"/>
    <text x="35" y="25" style="fill: #2c3e50; font-family: Arial; font-size: 13px;">Critical - Direct exploitation</text>

    <rect x="0" y="40" width="30" height="20" class="high-box" rx="2"/>
    <text x="35" y="55" style="fill: #2c3e50; font-family: Arial; font-size: 13px;">High - Requires additional primitives</text>

    <rect x="0" y="70" width="30" height="20" class="medium-box" rx="2"/>
    <text x="35" y="85" style="fill: #2c3e50; font-family: Arial; font-size: 13px;">Medium - Requires memory leak/oracle</text>

    <rect x="0" y="100" width="30" height="20" class="safe-box" rx="2"/>
    <text x="35" y="115" style="fill: #2c3e50; font-family: Arial; font-size: 13px;">Safe - Properly protected by PAC</text>

    <rect x="0" y="130" width="30" height="20" class="stage-box" rx="2"/>
    <text x="35" y="145" style="fill: #2c3e50; font-family: Arial; font-size: 13px;">Processing stage</text>
  </g>

  <!-- Source reference -->
  <text x="500" y="1750" style="fill: #7f8c8d; font-family: Arial; font-size: 12px; text-anchor: middle; font-style: italic;">
    Source: src/pac.rs:30-203 (detect_pac_vulnerabilities), src/gadget.rs:8-57
  </text>

  <!-- Footer -->
  <text x="500" y="1780" style="fill: #95a5a6; font-family: Arial; font-size: 11px; text-anchor: middle;">
    pacrops - PAC-aware ROP Gadget Finder | github.com/yourusername/pacrops
  </text>
</svg>
